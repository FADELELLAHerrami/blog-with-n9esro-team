import e from"net";import r from"process";import o from"buffer";var t="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var i={};var s=o.Buffer;var n=r;var c=Array.prototype.slice,l=e;function Server(e,r){var o=this||t;(this||t).origins=r||["*:*"];(this||t).port=843;(this||t).log=console.log;Object.keys(e).forEach((function(r){o[r]&&(o[r]=e[r])}));(this||t).socket=l.createServer((function createServer(e){e.on("error",(function socketError(){o.responder.call(o,e)}));o.responder.call(o,e)}));(this||t).socket.on("error",(function serverError(e){if(13==e.errno){o.log&&o.log("Unable to listen to port `"+o.port+"` as your Node.js instance does not have root privileges. "+(o.server?"The Flash Policy File requests will only be served inline over the supplied HTTP server. Inline serving is slower than a dedicated server instance.":"No fallback server supplied, we will be unable to answer Flash Policy File requests."));o.emit("connect_failed",e);o.socket.removeAllListeners();delete o.socket}else o.log&&o.log("FlashPolicyFileServer received an error event:\n"+(e.message?e.message:e))}));(this||t).socket.on("timeout",(function serverTimeout(){}));(this||t).socket.on("close",(function serverClosed(e){e&&o.log&&o.log("Server closing due to an error: \n"+(e.message?e.message:e));if(o.server){o.server["@"]&&o.server.online&&o.server.removeListener("connection",o.server["@"]);delete o.server.online}}));this.compile()}Server.prototype.listen=function listen(e,r,o){var i=this||t,s=c.call(arguments,0),n;s.forEach((function args(e){var r=typeof e;"number"===r&&(i.port=e);"function"===r&&(n=e);"object"===r&&(i.server=e)}));if((this||t).server){(this||t).server["@"]=function connection(e){e.once("data",(function requestData(r){if(r&&60===r[0]&&"<policy-file-request/>\0"===r.toString()&&e&&("open"===e.readyState||"writeOnly"===e.readyState))try{e.end(i.buffer)}catch(e){}}))};(this||t).server.on("connection",(this||t).server["@"])}(this||t).port>=0&&(this||t).socket.listen((this||t).port,(function serverListening(){i.socket.online=true;if(n){n.call(i);n=void 0}}));return this||t};Server.prototype.responder=function responder(e){if(e&&"open"==e.readyState&&e.end)try{e.end((this||t).buffer)}catch(e){}};Server.prototype.compile=function compile(){var e=['<?xml version="1.0"?>','<!DOCTYPE cross-domain-policy SYSTEM "http://www.macromedia.com/xml/dtds/cross-domain-policy.dtd">',"<cross-domain-policy>"];(this||t).origins.forEach((function origin(origin){var r=origin.split(":");e.push('<allow-access-from domain="'+r[0]+'" to-ports="'+r[1]+'"/>')}));e.push("</cross-domain-policy>");(this||t).buffer=new s(e.join(""),"utf8");return this||t};Server.prototype.add=function add(){var e=c.call(arguments,0),r=e.length;while(r--)(this||t).origins.indexOf(e[r])>=0&&(e[r]=null);Array.prototype.push.apply((this||t).origins,e.filter((function filter(e){return!!e})));this.compile();return this||t};Server.prototype.remove=function remove(e){var r=(this||t).origins.indexOf(e);if(r>0){(this||t).origins.splice(r,1);this.compile()}return this||t};Server.prototype.close=function close(){(this||t).socket.removeAllListeners();(this||t).socket.close();return this||t};Object.keys(n.EventEmitter.prototype).forEach((function proxy(e){Server.prototype[e]=Server.prototype[e]||function(){(this||t).socket&&(this||t).socket[e].apply((this||t).socket,arguments);return this||t}}));i.createServer=function createServer(e,r){r=Array.isArray(r)?r:!!Array.isArray(e)&&e;e=!Array.isArray(e)&&e?e:{};return new Server(e,r)};i.Server=Server;i.version="0.0.4";const a=i.createServer,p=i.Server,v=i.version;export default i;export{p as Server,a as createServer,v as version};

