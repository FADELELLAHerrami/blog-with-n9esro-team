import e from"redis";import t from"crypto";var i="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var n={};n=RedSess;var s=e,o=null;function RedSess(e,t,n){if(o){var s=sessionToken(e,t,n);if(false===s)throw new Error("could not load session token");(this||i).id="session:"+s;(this||i).client=o;(this||i).request=e;(this||i).response=t;(this||i).expire=n&&n.expire||60*60*24*14}else{console.error("RedSess: no client yet",e.url,e.headers);t.statusCode=503;t.setHeader("content-type","text/plain");t.setHeader("retry-after","10");t.end("Redis client not yet loaded.\n")}}RedSess.createClient=function(e){e=e||{};o=s.createClient(e.port,e.host,e);e.auth&&o.auth(e.auth)};RedSess.quit=RedSess.close=RedSess.end=function(e){if(!o)return e&&e();e&&o.once("end",e);o.quit()};RedSess.destroy=function(){o.end()};RedSess.prototype.del=function(e,t){if("function"===typeof e||!e&&!t)return this.delAll(e||t);(this||i).client.hkeys((this||i).id,function(n,s){if(n)return t&&t(n);var s=s.filter((function(t){return t.split(/:/)[0]===e}));if(!s.length)return t&&t();s.unshift((this||i).id);(this||i).client.hdel(s,function(e){(this||i).client.expire((this||i).id,(this||i).expire);if(t)return t(e)}.bind(this||i))}.bind(this||i))};RedSess.prototype.delAll=function(e){(this||i).client.del((this||i).id,e||function(){})};RedSess.prototype.set=function(e,t,n){var s={};"function"===typeof t&&(n=t,t=null);t?s[e]=t:s=e;s=flatten(s);(this||i).client.hmset((this||i).id,s,function(e){(this||i).client.expire((this||i).id,(this||i).expire);if(n)return n(e)}.bind(this||i))};RedSess.prototype.get=function(e,t){if("function"===typeof e||!e)return this.getAll(e||t);if(!t)return(this||i).client.expire((this||i).id,(this||i).expire);this.getAll(function(i,n){if(i)return t(i);n=n[e]||null;return t(null,n)}.bind(this||i))};RedSess.prototype.getAll=function(e){if(!e)return(this||i).client.expire((this||i).id,(this||i).expire);(this||i).client.hgetall((this||i).id,function(t,n){(this||i).client.expire((this||i).id,(this||i).expire);return t?e(t):e(t,unflatten(n))}.bind(this||i))};function flatten(e,t,i){if(!e)return e;t=t||{};i=i||"";i&&(i+=":");Object.keys(e).forEach((function(n){e[n]&&"object"===typeof e[n]?flatten(e[n],t,i+n):t[i+n]=e[n]}));return t}function unflatten(e){if(!e||"object"!==typeof e)return e;var t={};Object.keys(e).forEach((function(i){var n=i.split(/:/),s=n.pop(),o=t;n.forEach((function(e){o[e]&&"object"===typeof o[e]||(o[e]={});o=o[e]}));o[s]=e[i]}));return t}function sessionToken(e,i,n){if(!e.cookies){i.statusCode=500;i.setHeader("content-type","text/plain");i.end("RedSess requires a cookies implementation");return false}var s=e.cookies.get(n&&n.cookieName||"s",{signed:!!e.cookies.keys});if(s)return e.sessionToken=i.sessionToken=s;s=t.randomBytes(30).toString("base64");i.cookies.set(n&&n.cookieName||"s",s,{signed:!!i.cookies.keys});return e.sessionToken=i.sessionToken=s}var r=n;export default r;

