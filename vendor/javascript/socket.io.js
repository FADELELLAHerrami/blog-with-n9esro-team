import e from"socket.io-client";import t from"https";import o from"http";import r from"fs";import i from"url";import{e as n}from"./_/a06bfc37.js";import s from"process";import{_ as a,a as c}from"./_/26ed2fec.js";import{e as h,_ as l}from"./_/6e1030be.js";import p from"crypto";import u from"buffer";import f from"policyfile";import d from"querystring";import g from"./lib/logger.js";import m from"./lib/namespace.js";import v from"child_process";import"assert";import"msgpack";import"redis";var b="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var y={};var k=h;y=y=Transport;function Transport(e,t,o){(this||b).manager=e;(this||b).id=t.id;(this||b).disconnected=false;(this||b).drained=true;this.handleRequest(o)}Transport.prototype.__defineGetter__("log",(function(){return(this||b).manager.log}));Transport.prototype.__defineGetter__("store",(function(){return(this||b).manager.store}));Transport.prototype.handleRequest=function(e){(this||b).log.debug("setting request",e.method,e.url);(this||b).req=e;if("GET"==e.method){(this||b).socket=e.socket;(this||b).open=true;(this||b).drained=true;this.setHeartbeatInterval();this.setHandlers();this.onSocketConnect()}};Transport.prototype.onSocketConnect=function(){};Transport.prototype.setHandlers=function(){var e=this||b;(this||b).store.subscribe("heartbeat-clear:"+(this||b).id,(function(){e.onHeartbeatClear()}));(this||b).store.subscribe("disconnect-force:"+(this||b).id,(function(){e.onForcedDisconnect()}));(this||b).store.subscribe("dispatch:"+(this||b).id,(function(t,o){e.onDispatch(t,o)}));(this||b).bound={end:(this||b).onSocketEnd.bind(this||b),close:(this||b).onSocketClose.bind(this||b),error:(this||b).onSocketError.bind(this||b),drain:(this||b).onSocketDrain.bind(this||b)};(this||b).socket.on("end",(this||b).bound.end);(this||b).socket.on("close",(this||b).bound.close);(this||b).socket.on("error",(this||b).bound.error);(this||b).socket.on("drain",(this||b).bound.drain);(this||b).handlersSet=true};Transport.prototype.clearHandlers=function(){if((this||b).handlersSet){(this||b).store.unsubscribe("disconnect-force:"+(this||b).id);(this||b).store.unsubscribe("heartbeat-clear:"+(this||b).id);(this||b).store.unsubscribe("dispatch:"+(this||b).id);(this||b).socket.removeListener("end",(this||b).bound.end);(this||b).socket.removeListener("close",(this||b).bound.close);(this||b).socket.removeListener("error",(this||b).bound.error);(this||b).socket.removeListener("drain",(this||b).bound.drain)}};Transport.prototype.onSocketEnd=function(){this.end("socket end")};Transport.prototype.onSocketClose=function(e){this.end(e?"socket error":"socket close")};Transport.prototype.onSocketError=function(e){if((this||b).open){(this||b).socket.destroy();this.onClose()}(this||b).log.info("socket error "+e.stack)};Transport.prototype.onSocketDrain=function(){(this||b).drained=true};Transport.prototype.onHeartbeatClear=function(){this.clearHeartbeatTimeout();this.setHeartbeatInterval()};Transport.prototype.onForcedDisconnect=function(){if(!(this||b).disconnected){(this||b).log.info("transport end by forced client disconnection");(this||b).open&&this.packet({type:"disconnect"});this.end("booted")}};Transport.prototype.onDispatch=function(e,t){t?this.writeVolatile(e):this.write(e)};Transport.prototype.setCloseTimeout=function(){if(!(this||b).closeTimeout){var e=this||b;(this||b).closeTimeout=setTimeout((function(){e.log.debug("fired close timeout for client",e.id);e.closeTimeout=null;e.end("close timeout")}),1e3*(this||b).manager.get("close timeout"));(this||b).log.debug("set close timeout for client",(this||b).id)}};Transport.prototype.clearCloseTimeout=function(){if((this||b).closeTimeout){clearTimeout((this||b).closeTimeout);(this||b).closeTimeout=null;(this||b).log.debug("cleared close timeout for client",(this||b).id)}};Transport.prototype.setHeartbeatTimeout=function(){if(!(this||b).heartbeatTimeout&&(this||b).manager.enabled("heartbeats")){var e=this||b;(this||b).heartbeatTimeout=setTimeout((function(){e.log.debug("fired heartbeat timeout for client",e.id);e.heartbeatTimeout=null;e.end("heartbeat timeout")}),1e3*(this||b).manager.get("heartbeat timeout"));(this||b).log.debug("set heartbeat timeout for client",(this||b).id)}};Transport.prototype.clearHeartbeatTimeout=function(){if((this||b).heartbeatTimeout&&(this||b).manager.enabled("heartbeats")){clearTimeout((this||b).heartbeatTimeout);(this||b).heartbeatTimeout=null;(this||b).log.debug("cleared heartbeat timeout for client",(this||b).id)}};Transport.prototype.setHeartbeatInterval=function(){if(!(this||b).heartbeatInterval&&(this||b).manager.enabled("heartbeats")){var e=this||b;(this||b).heartbeatInterval=setTimeout((function(){e.heartbeat();e.heartbeatInterval=null}),1e3*(this||b).manager.get("heartbeat interval"));(this||b).log.debug("set heartbeat interval for client",(this||b).id)}};Transport.prototype.clearTimeouts=function(){this.clearCloseTimeout();this.clearHeartbeatTimeout();this.clearHeartbeatInterval()};Transport.prototype.heartbeat=function(){if((this||b).open){(this||b).log.debug("emitting heartbeat for client",(this||b).id);this.packet({type:"heartbeat"});this.setHeartbeatTimeout()}return this||b};Transport.prototype.onMessage=function(e){var t=(this||b).manager.transports[(this||b).id];if("heartbeat"==e.type){(this||b).log.debug("got heartbeat packet");t&&t.open?t.onHeartbeatClear():(this||b).store.publish("heartbeat-clear:"+(this||b).id)}else{if("disconnect"==e.type&&""==e.endpoint){(this||b).log.debug("got disconnection packet");t?t.onForcedDisconnect():(this||b).store.publish("disconnect-force:"+(this||b).id);return}if(e.id&&"data"!=e.ack){(this||b).log.debug("acknowledging packet automatically");var o=k.encodePacket({type:"ack",ackId:e.id,endpoint:e.endpoint||""});if(t&&t.open)t.onDispatch(o);else{(this||b).manager.onClientDispatch((this||b).id,o);(this||b).store.publish("dispatch:"+(this||b).id,o)}}t?(this||b).manager.onClientMessage((this||b).id,e):(this||b).store.publish("message:"+(this||b).id,e)}};Transport.prototype.clearHeartbeatInterval=function(){if((this||b).heartbeatInterval&&(this||b).manager.enabled("heartbeats")){clearTimeout((this||b).heartbeatInterval);(this||b).heartbeatInterval=null;(this||b).log.debug("cleared heartbeat interval for client",(this||b).id)}};Transport.prototype.disconnect=function(e){this.packet({type:"disconnect"});this.end(e);return this||b};Transport.prototype.close=function(){if((this||b).open){this.doClose();this.onClose()}};Transport.prototype.onClose=function(){if((this||b).open){this.setCloseTimeout();this.clearHandlers();(this||b).open=false;(this||b).manager.onClose((this||b).id);(this||b).store.publish("close",(this||b).id)}};Transport.prototype.end=function(e){if(!(this||b).disconnected){(this||b).log.info("transport end");var t=(this||b).manager.transports[(this||b).id];this.close();this.clearTimeouts();(this||b).disconnected=true;t?(this||b).manager.onClientDisconnect((this||b).id,e,true):(this||b).store.publish("disconnect:"+(this||b).id,e)}};Transport.prototype.discard=function(){(this||b).log.debug("discarding transport");(this||b).discarded=true;this.clearTimeouts();this.clearHandlers();return this||b};Transport.prototype.error=function(e,t){this.packet({type:"error",reason:e,advice:t});(this||b).log.warn(e,t?"client should "+t:"");this.end("error")};Transport.prototype.packet=function(e){return this.write(k.encodePacket(e))};Transport.prototype.writeVolatile=function(e){(this||b).open?(this||b).drained?this.write(e):(this||b).log.debug("ignoring volatile packet, buffer not drained"):(this||b).log.debug("ignoring volatile packet, transport not open")};var w=y;var T="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var x={};var S=u.Buffer;var P=s;var C=w,M=P.EventEmitter,O=p,H=i,_=h,q=n;x=x=WebSocket;x.Parser=Parser;function WebSocket(e,t,o){var r=this||T;(this||T).manager=e;(this||T).parser=new Parser;(this||T).parser.on("data",(function(e){r.onMessage(_.decodePacket(e))}));(this||T).parser.on("ping",(function(){try{r.socket.write("ÂŠ\0")}catch(e){r.end();return}}));(this||T).parser.on("close",(function(){r.end()}));(this||T).parser.on("error",(function(e){r.log.warn(r.name+" parser error: "+e);r.end()}));C.call(this||T,e,t,o)}WebSocket.prototype.__proto__=C.prototype;WebSocket.prototype.name="websocket";WebSocket.prototype.protocolVersion="07-12";WebSocket.prototype.onSocketConnect=function(){var e=this||T;if("websocket"===(this||T).req.headers.upgrade.toLowerCase()){var t=(this||T).req.headers["sec-websocket-origin"],o=((this||T).socket.encrypted?"wss":"ws")+"://"+(this||T).req.headers.host+(this||T).req.url;if(this.verifyOrigin(t))if((this||T).req.headers["sec-websocket-key"]){var r=(this||T).req.headers["sec-websocket-key"];var i=O.createHash("sha1");i.update(r+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11");r=i.digest("base64");var n=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+r];try{(this||T).socket.write(n.concat("","").join("\r\n"));(this||T).socket.setTimeout(0);(this||T).socket.setNoDelay(true)}catch(e){this.end();return}(this||T).socket.on("data",(function(t){e.parser.add(t)}))}else{(this||T).log.warn((this||T).name+" connection invalid: received no key");this.end()}else{(this||T).log.warn((this||T).name+" connection invalid: origin mismatch");this.end()}}else{(this||T).log.warn((this||T).name+" connection invalid");this.end()}};WebSocket.prototype.verifyOrigin=function(e){var t=(this||T).manager.get("origins");"null"===e&&(e="*");if(-1!==t.indexOf("*:*"))return true;if(e)try{var o=H.parse(e);var r=~t.indexOf(o.hostname+":"+o.port)||~t.indexOf(o.hostname+":*")||~t.indexOf("*:"+o.port);r||(this||T).log.warn("illegal origin: "+e);return r}catch(e){(this||T).log.warn("error parsing origin")}else(this||T).log.warn("origin missing from websocket call, yet required by config");return false};WebSocket.prototype.write=function(e){if((this||T).open){var t=this.frame(129,e);try{(this||T).socket.write(t,"binary")}catch(e){this.end();return}(this||T).log.debug((this||T).name+" writing",e)}};WebSocket.prototype.payload=function(e){for(var t=0,o=e.length;t<o;t++)this.write(e[t]);return this||T};WebSocket.prototype.frame=function(e,t){var o=new S(t),r=o.length,i=2,n=r;if(r>65536){i=10;n=127}else if(r>125){i=4;n=126}var s=new S(r+i);s[0]=e;s[1]=n;o.copy(s,i);switch(n){case 126:s[2]=r>>>8;s[3]=r%256;break;case 127:var a=r;for(var c=1;c<=8;++c){s[i-c]=255&a;a>>>=8}}return s};WebSocket.prototype.doClose=function(){(this||T).socket.end()};function Parser(){(this||T).state={activeFragmentedOperation:null,lastFragment:false,masked:false,opcode:0};(this||T).overflow=null;(this||T).expectOffset=0;(this||T).expectBuffer=null;(this||T).expectHandler=null;(this||T).currentMessage="";var e=this||T;(this||T).opcodeHandlers={1:function(t){var finish=function(t,o){e.currentMessage+=e.unmask(t,o);if(e.state.lastFragment){e.emit("data",e.currentMessage);e.currentMessage=""}e.endPacket()};var expectData=function(t){e.state.masked?e.expect("Mask",4,(function(o){var r=o;e.expect("Data",t,(function(e){finish(r,e)}))})):e.expect("Data",t,(function(e){finish(null,e)}))};var o=127&t[1];o<126?expectData(o):126==o?e.expect("Length",2,(function(e){expectData(q.unpack(e))})):127==o&&e.expect("Length",8,(function(t){if(0==q.unpack(t.slice(0,4))){var o=t.slice(4);expectData(q.unpack(t))}else e.error("packets with length spanning more than 32 bit is currently not supported")}))},2:function(t){var finish=function(t,o){"string"==typeof e.currentMessage&&(e.currentMessage=[]);e.currentMessage.push(e.unmask(t,o,true));if(e.state.lastFragment){e.emit("binary",e.concatBuffers(e.currentMessage));e.currentMessage=""}e.endPacket()};var expectData=function(t){e.state.masked?e.expect("Mask",4,(function(o){var r=o;e.expect("Data",t,(function(e){finish(r,e)}))})):e.expect("Data",t,(function(e){finish(null,e)}))};var o=127&t[1];o<126?expectData(o):126==o?e.expect("Length",2,(function(e){expectData(q.unpack(e))})):127==o&&e.expect("Length",8,(function(t){if(0==q.unpack(t.slice(0,4))){var o=t.slice(4);expectData(q.unpack(t))}else e.error("packets with length spanning more than 32 bit is currently not supported")}))},8:function(t){e.emit("close");e.reset()},9:function(t){if(false!=e.state.lastFragment){var finish=function(t,o){e.emit("ping",e.unmask(t,o));e.endPacket()};var expectData=function(t){e.state.masked?e.expect("Mask",4,(function(o){var r=o;e.expect("Data",t,(function(e){finish(r,e)}))})):e.expect("Data",t,(function(e){finish(null,e)}))};var o=127&t[1];0==o?finish(null,null):o<126?expectData(o):126==o?e.expect("Length",2,(function(e){expectData(q.unpack(e))})):127==o&&e.expect("Length",8,(function(e){expectData(q.unpack(e))}))}else e.error("fragmented ping is not supported")}};this.expect("Opcode",2,(this||T).processPacket)}Parser.prototype.__proto__=M.prototype;Parser.prototype.add=function(e){if(null!=(this||T).expectBuffer){var t=Math.min(e.length,(this||T).expectBuffer.length-(this||T).expectOffset);e.copy((this||T).expectBuffer,(this||T).expectOffset,0,t);(this||T).expectOffset+=t;if(t<e.length){(this||T).overflow=new S(e.length-t);e.copy((this||T).overflow,0,t,t+(this||T).overflow.length)}if((this||T).expectOffset==(this||T).expectBuffer.length){var o=(this||T).expectBuffer;(this||T).expectBuffer=null;(this||T).expectOffset=0;(this||T).expectHandler.call(this||T,o)}}else this.addToOverflow(e)};Parser.prototype.addToOverflow=function(e){if(null==(this||T).overflow)(this||T).overflow=e;else{var t=(this||T).overflow;(this||T).overflow=new S((this||T).overflow.length+e.length);t.copy((this||T).overflow,0);e.copy((this||T).overflow,t.length)}};Parser.prototype.expect=function(e,t,o){(this||T).expectBuffer=new S(t);(this||T).expectOffset=0;(this||T).expectHandler=o;if(null!=(this||T).overflow){var r=(this||T).overflow;(this||T).overflow=null;this.add(r)}};Parser.prototype.processPacket=function(e){0!=(112&e[0])&&this.error("reserved fields must be empty");(this||T).state.lastFragment=128==(128&e[0]);(this||T).state.masked=128==(128&e[1]);var t=15&e[0];if(0==t){(this||T).state.opcode=(this||T).state.activeFragmentedOperation;if(!(1==(this||T).state.opcode||2==(this||T).state.opcode)){this.error("continuation frame cannot follow current opcode");return}}else{(this||T).state.opcode=t;false===(this||T).state.lastFragment&&((this||T).state.activeFragmentedOperation=t)}var o=(this||T).opcodeHandlers[(this||T).state.opcode];"undefined"==typeof o?this.error("no handler for opcode "+(this||T).state.opcode):o(e)};Parser.prototype.endPacket=function(){(this||T).expectOffset=0;(this||T).expectBuffer=null;(this||T).expectHandler=null;(this||T).state.lastFragment&&(this||T).state.opcode==(this||T).state.activeFragmentedOperation&&((this||T).state.activeFragmentedOperation=null);(this||T).state.lastFragment=false;(this||T).state.opcode=null!=(this||T).state.activeFragmentedOperation?(this||T).state.activeFragmentedOperation:0;(this||T).state.masked=false;this.expect("Opcode",2,(this||T).processPacket)};Parser.prototype.reset=function(){(this||T).state={activeFragmentedOperation:null,lastFragment:false,masked:false,opcode:0};(this||T).expectOffset=0;(this||T).expectBuffer=null;(this||T).expectHandler=null;(this||T).overflow=null;(this||T).currentMessage=""};Parser.prototype.unmask=function(e,t,o){if(null!=e)for(var r=0,i=t.length;r<i;r++)t[r]^=e[r%4];return o?t:null!=t?t.toString("utf8"):""};Parser.prototype.concatBuffers=function(e){var t=0;for(var o=0,r=e.length;o<r;++o)t+=e[o].length;var i=new S(t);var n=0;for(var o=0,r=e.length;o<r;++o){e[o].copy(i,n);n+=e[o].length}return i};Parser.prototype.error=function(e){this.reset();this.emit("error",e);return this||T};var D=x;var W="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var F={};var $=u.Buffer;var A=s;var L=w,E=A.EventEmitter,j=p,B=i,z=h,R=n;F=F=WebSocket$1;F.Parser=Parser$1;function WebSocket$1(e,t,o){var r=this||W;(this||W).manager=e;(this||W).parser=new Parser$1;(this||W).parser.on("data",(function(e){r.onMessage(z.decodePacket(e))}));(this||W).parser.on("ping",(function(){try{r.socket.write("ÂŠ\0")}catch(e){r.end();return}}));(this||W).parser.on("close",(function(){r.end()}));(this||W).parser.on("error",(function(e){r.log.warn(r.name+" parser error: "+e);r.end()}));L.call(this||W,e,t,o)}WebSocket$1.prototype.__proto__=L.prototype;WebSocket$1.prototype.name="websocket";WebSocket$1.prototype.protocolVersion="16";WebSocket$1.prototype.onSocketConnect=function(){var e=this||W;if("websocket"===(this||W).req.headers.upgrade.toLowerCase()){var t=(this||W).req.headers["origin"],o=((this||W).socket.encrypted?"wss":"ws")+"://"+(this||W).req.headers.host+(this||W).req.url;if(this.verifyOrigin(t))if((this||W).req.headers["sec-websocket-key"]){var r=(this||W).req.headers["sec-websocket-key"];var i=j.createHash("sha1");i.update(r+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11");r=i.digest("base64");var n=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+r];try{(this||W).socket.write(n.concat("","").join("\r\n"));(this||W).socket.setTimeout(0);(this||W).socket.setNoDelay(true)}catch(e){this.end();return}(this||W).socket.on("data",(function(t){e.parser.add(t)}))}else{(this||W).log.warn((this||W).name+" connection invalid: received no key");this.end()}else{(this||W).log.warn((this||W).name+" connection invalid: origin mismatch");this.end()}}else{(this||W).log.warn((this||W).name+" connection invalid");this.end()}};WebSocket$1.prototype.verifyOrigin=function(e){var t=(this||W).manager.get("origins");"null"===e&&(e="*");if(-1!==t.indexOf("*:*"))return true;if(e)try{var o=B.parse(e);var r=~t.indexOf(o.hostname+":"+o.port)||~t.indexOf(o.hostname+":*")||~t.indexOf("*:"+o.port);r||(this||W).log.warn("illegal origin: "+e);return r}catch(e){(this||W).log.warn("error parsing origin")}else(this||W).log.warn("origin missing from websocket call, yet required by config");return false};WebSocket$1.prototype.write=function(e){if((this||W).open){var t=this.frame(129,e);try{(this||W).socket.write(t,"binary")}catch(e){this.end();return}(this||W).log.debug((this||W).name+" writing",e)}};WebSocket$1.prototype.payload=function(e){for(var t=0,o=e.length;t<o;t++)this.write(e[t]);return this||W};WebSocket$1.prototype.frame=function(e,t){var o=new $(t),r=o.length,i=2,n=r;if(r>65536){i=10;n=127}else if(r>125){i=4;n=126}var s=new $(r+i);s[0]=e;s[1]=n;o.copy(s,i);switch(n){case 126:s[2]=r>>>8;s[3]=r%256;break;case 127:var a=r;for(var c=1;c<=8;++c){s[i-c]=255&a;a>>>=8}}return s};WebSocket$1.prototype.doClose=function(){(this||W).socket.end()};function Parser$1(){(this||W).state={activeFragmentedOperation:null,lastFragment:false,masked:false,opcode:0};(this||W).overflow=null;(this||W).expectOffset=0;(this||W).expectBuffer=null;(this||W).expectHandler=null;(this||W).currentMessage="";var e=this||W;(this||W).opcodeHandlers={1:function(t){var finish=function(t,o){e.currentMessage+=e.unmask(t,o);if(e.state.lastFragment){e.emit("data",e.currentMessage);e.currentMessage=""}e.endPacket()};var expectData=function(t){e.state.masked?e.expect("Mask",4,(function(o){var r=o;e.expect("Data",t,(function(e){finish(r,e)}))})):e.expect("Data",t,(function(e){finish(null,e)}))};var o=127&t[1];o<126?expectData(o):126==o?e.expect("Length",2,(function(e){expectData(R.unpack(e))})):127==o&&e.expect("Length",8,(function(t){if(0==R.unpack(t.slice(0,4))){var o=t.slice(4);expectData(R.unpack(t))}else e.error("packets with length spanning more than 32 bit is currently not supported")}))},2:function(t){var finish=function(t,o){"string"==typeof e.currentMessage&&(e.currentMessage=[]);e.currentMessage.push(e.unmask(t,o,true));if(e.state.lastFragment){e.emit("binary",e.concatBuffers(e.currentMessage));e.currentMessage=""}e.endPacket()};var expectData=function(t){e.state.masked?e.expect("Mask",4,(function(o){var r=o;e.expect("Data",t,(function(e){finish(r,e)}))})):e.expect("Data",t,(function(e){finish(null,e)}))};var o=127&t[1];o<126?expectData(o):126==o?e.expect("Length",2,(function(e){expectData(R.unpack(e))})):127==o&&e.expect("Length",8,(function(t){if(0==R.unpack(t.slice(0,4))){var o=t.slice(4);expectData(R.unpack(t))}else e.error("packets with length spanning more than 32 bit is currently not supported")}))},8:function(t){e.emit("close");e.reset()},9:function(t){if(false!=e.state.lastFragment){var finish=function(t,o){e.emit("ping",e.unmask(t,o));e.endPacket()};var expectData=function(t){e.state.masked?e.expect("Mask",4,(function(o){var r=o;e.expect("Data",t,(function(e){finish(r,e)}))})):e.expect("Data",t,(function(e){finish(null,e)}))};var o=127&t[1];0==o?finish(null,null):o<126?expectData(o):126==o?e.expect("Length",2,(function(e){expectData(R.unpack(e))})):127==o&&e.expect("Length",8,(function(e){expectData(R.unpack(e))}))}else e.error("fragmented ping is not supported")}};this.expect("Opcode",2,(this||W).processPacket)}Parser$1.prototype.__proto__=E.prototype;Parser$1.prototype.add=function(e){if(null!=(this||W).expectBuffer){var t=Math.min(e.length,(this||W).expectBuffer.length-(this||W).expectOffset);e.copy((this||W).expectBuffer,(this||W).expectOffset,0,t);(this||W).expectOffset+=t;if(t<e.length){(this||W).overflow=new $(e.length-t);e.copy((this||W).overflow,0,t,t+(this||W).overflow.length)}if((this||W).expectOffset==(this||W).expectBuffer.length){var o=(this||W).expectBuffer;(this||W).expectBuffer=null;(this||W).expectOffset=0;(this||W).expectHandler.call(this||W,o)}}else this.addToOverflow(e)};Parser$1.prototype.addToOverflow=function(e){if(null==(this||W).overflow)(this||W).overflow=e;else{var t=(this||W).overflow;(this||W).overflow=new $((this||W).overflow.length+e.length);t.copy((this||W).overflow,0);e.copy((this||W).overflow,t.length)}};Parser$1.prototype.expect=function(e,t,o){(this||W).expectBuffer=new $(t);(this||W).expectOffset=0;(this||W).expectHandler=o;if(null!=(this||W).overflow){var r=(this||W).overflow;(this||W).overflow=null;this.add(r)}};Parser$1.prototype.processPacket=function(e){0!=(112&e[0])&&this.error("reserved fields must be empty");(this||W).state.lastFragment=128==(128&e[0]);(this||W).state.masked=128==(128&e[1]);var t=15&e[0];if(0==t){(this||W).state.opcode=(this||W).state.activeFragmentedOperation;if(!(1==(this||W).state.opcode||2==(this||W).state.opcode)){this.error("continuation frame cannot follow current opcode");return}}else{(this||W).state.opcode=t;false===(this||W).state.lastFragment&&((this||W).state.activeFragmentedOperation=t)}var o=(this||W).opcodeHandlers[(this||W).state.opcode];"undefined"==typeof o?this.error("no handler for opcode "+(this||W).state.opcode):o(e)};Parser$1.prototype.endPacket=function(){(this||W).expectOffset=0;(this||W).expectBuffer=null;(this||W).expectHandler=null;(this||W).state.lastFragment&&(this||W).state.opcode==(this||W).state.activeFragmentedOperation&&((this||W).state.activeFragmentedOperation=null);(this||W).state.lastFragment=false;(this||W).state.opcode=null!=(this||W).state.activeFragmentedOperation?(this||W).state.activeFragmentedOperation:0;(this||W).state.masked=false;this.expect("Opcode",2,(this||W).processPacket)};Parser$1.prototype.reset=function(){(this||W).state={activeFragmentedOperation:null,lastFragment:false,masked:false,opcode:0};(this||W).expectOffset=0;(this||W).expectBuffer=null;(this||W).expectHandler=null;(this||W).overflow=null;(this||W).currentMessage=""};Parser$1.prototype.unmask=function(e,t,o){if(null!=e)for(var r=0,i=t.length;r<i;r++)t[r]^=e[r%4];return o?t:null!=t?t.toString("utf8"):""};Parser$1.prototype.concatBuffers=function(e){var t=0;for(var o=0,r=e.length;o<r;++o)t+=e[o].length;var i=new $(t);var n=0;for(var o=0,r=e.length;o<r;++o){e[o].copy(i,n);n+=e[o].length}return i};Parser$1.prototype.error=function(e){this.reset();this.emit("error",e);return this||W};var I=F;var N="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var U={};var J=u.Buffer;var G=s;var V=w,X=G.EventEmitter,K=p,Q=h;U=U=WebSocket$2;function WebSocket$2(e,t,o){var r=this||N;(this||N).parser=new Parser$2;(this||N).parser.on("data",(function(e){r.log.debug(r.name+" received data packet",e);r.onMessage(Q.decodePacket(e))}));(this||N).parser.on("close",(function(){r.end()}));(this||N).parser.on("error",(function(){r.end()}));V.call(this||N,e,t,o)}WebSocket$2.prototype.__proto__=V.prototype;WebSocket$2.prototype.name="websocket";WebSocket$2.prototype.protocolVersion="hixie-76";WebSocket$2.prototype.onSocketConnect=function(){var e=this||N;(this||N).socket.setNoDelay(true);(this||N).buffer=true;(this||N).buffered=[];if("WebSocket"===(this||N).req.headers.upgrade){var t=(this||N).req.headers.origin,o=((this||N).socket.encrypted?"wss":"ws")+"://"+(this||N).req.headers.host+(this||N).req.url,r=false;if((this||N).req.headers["sec-websocket-key1"]){(this||N).req.head&&(this||N).req.head.length>=8||(r=true);var i=["HTTP/1.1 101 WebSocket Protocol Handshake","Upgrade: WebSocket","Connection: Upgrade","Sec-WebSocket-Origin: "+t,"Sec-WebSocket-Location: "+o];(this||N).req.headers["sec-websocket-protocol"]&&i.push("Sec-WebSocket-Protocol: "+(this||N).req.headers["sec-websocket-protocol"])}else var i=["HTTP/1.1 101 Web Socket Protocol Handshake","Upgrade: WebSocket","Connection: Upgrade","WebSocket-Origin: "+t,"WebSocket-Location: "+o];try{(this||N).socket.write(i.concat("","").join("\r\n"));(this||N).socket.setTimeout(0);(this||N).socket.setNoDelay(true);(this||N).socket.setEncoding("utf8")}catch(e){this.end();return}r?(this||N).socket.setEncoding("binary"):this.proveReception(i)&&e.flush();var n="";(this||N).socket.on("data",(function(t){if(r){n+=t;if(n.length<8)return;e.socket.setEncoding("utf8");r=false;e.req.head=n.substr(0,8);n="";e.proveReception(i)&&e.flush()}else e.parser.add(t)}))}else{(this||N).log.warn((this||N).name+" connection invalid");this.end()}};WebSocket$2.prototype.write=function(e){if((this||N).open){(this||N).drained=false;if((this||N).buffer){(this||N).buffered.push(e);return this||N}var t=J.byteLength(e),o=new J(2+t);o.write("\0","binary");o.write(e,1,"utf8");o.write("Ã¿",1+t,"binary");try{(this||N).socket.write(o)&&((this||N).drained=true)}catch(e){this.end()}(this||N).log.debug((this||N).name+" writing",e)}};WebSocket$2.prototype.flush=function(){(this||N).buffer=false;for(var e=0,t=(this||N).buffered.length;e<t;e++)this.write((this||N).buffered.splice(0,1)[0])};WebSocket$2.prototype.proveReception=function(e){var t=this||N,o=(this||N).req.headers["sec-websocket-key1"],r=(this||N).req.headers["sec-websocket-key2"];if(o&&r){var i=K.createHash("md5");[o,r].forEach((function(e){var o=parseInt(e.replace(/[^\d]/g,"")),r=e.replace(/[^ ]/g,"").length;if(0===r||o%r!==0){t.log.warn("Invalid "+t.name+' key: "'+e+'".');t.end();return false}o/=r;i.update(String.fromCharCode(o>>24&255,o>>16&255,o>>8&255,255&o))}));i.update((this||N).req.head.toString("binary"));try{(this||N).socket.write(i.digest("binary"),"binary")}catch(e){this.end()}}return true};WebSocket$2.prototype.payload=function(e){for(var t=0,o=e.length;t<o;t++)this.write(e[t]);return this||N};WebSocket$2.prototype.doClose=function(){(this||N).socket.end()};function Parser$2(){(this||N).buffer="";(this||N).i=0}Parser$2.prototype.__proto__=X.prototype;Parser$2.prototype.add=function(e){(this||N).buffer+=e;this.parse()};Parser$2.prototype.parse=function(){for(var e=(this||N).i,t,o=(this||N).buffer.length;e<o;e++){t=(this||N).buffer[e];if(2==(this||N).buffer.length&&"\0"==(this||N).buffer[1]){this.emit("close");(this||N).buffer="";(this||N).i=0;return}if(0===e){if("\0"==t)continue;this.error("Bad framing. Expected null byte as first frame")}if("ï¿½"==t){this.emit("data",(this||N).buffer.substr(1,e-1));(this||N).buffer=(this||N).buffer.substr(e+1);(this||N).i=0;return this.parse()}}};Parser$2.prototype.error=function(e){(this||N).buffer="";(this||N).i=0;this.emit("error",e);return this||N};var Y=U;var Z={};Z={7:D,8:D,13:I,default:Y};var ee=Z;var te="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var oe={};var re=ee;oe=oe=WebSocket$3;function WebSocket$3(e,t,o){var r,i=o.headers["sec-websocket-version"];r="undefined"!==typeof i&&"undefined"!==typeof re[i]?new re[i](e,t,o):new re["default"](e,t,o);"undefined"!==typeof(this||te).name&&(r.name=(this||te).name);return r}var ie=oe;var ne="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var se={};var ae=ie;se=se=FlashSocket;function FlashSocket(e,t,o){return ae.call(this||ne,e,t,o)}FlashSocket.prototype.__proto__=ae.prototype;FlashSocket.prototype.name="flashsocket";var ce;FlashSocket.init=function(e){function create(){ce=f.createServer({log:function(t){e.log.info(t.toLowerCase())}},e.get("origins"));ce.on("close",(function(e){ce=null}));ce.listen(e.get("flash policy port"),e.server);e.flashPolicyServer=ce}e.on("set:origins",(function(e,t){if(ce){ce.origins=Array.isArray(e)?e:[e];ce.compile()}}));e.on("set:flash policy port",(function(t,o){var r=e.get("transports");if(ce&&ce.port!==t&&~r.indexOf("flashsocket")){ce.close();create()}}));e.on("set:transports",(function(t,o){!ce&&~e.get("transports").indexOf("flashsocket")&&create()}));~e.get("transports").indexOf("flashsocket")&&create()};var he=se;var le="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var pe={};var ue=w,fe=h,de=d;pe=pe=HTTPTransport;function HTTPTransport(e,t,o){ue.call(this||le,e,t,o)}HTTPTransport.prototype.__proto__=ue.prototype;HTTPTransport.prototype.handleRequest=function(e){if("POST"==e.method){var t="",o=e.res,r=e.headers.origin,i={"Content-Length":1},n=this||le;e.on("data",(function(e){t+=e}));e.on("end",(function(){o.writeHead(200,i);o.end("1");n.onData(n.postEncoded?de.parse(t).d:t)}));if(r){i["Access-Control-Allow-Origin"]="*";e.headers.cookie&&(i["Access-Control-Allow-Credentials"]="true")}}else{(this||le).response=e.res;ue.prototype.handleRequest.call(this||le,e)}};HTTPTransport.prototype.onData=function(e){var t=fe.decodePayload(e);(this||le).log.debug((this||le).name+" received data packet",e);for(var o=0,r=t.length;o<r;o++)this.onMessage(t[o])};HTTPTransport.prototype.doClose=function(){(this||le).response.end()};HTTPTransport.prototype.payload=function(e){this.write(fe.encodePayload(e))};var ge=pe;var me="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var ve={};var be=ge;ve=ve=HTMLFile;function HTMLFile(e,t,o){be.call(this||me,e,t,o)}HTMLFile.prototype.__proto__=be.prototype;HTMLFile.prototype.name="htmlfile";HTMLFile.prototype.handleRequest=function(e){be.prototype.handleRequest.call(this||me,e);if("GET"==e.method){e.res.writeHead(200,{"Content-Type":"text/html; charset=UTF-8",Connection:"keep-alive","Transfer-Encoding":"chunked"});e.res.write("<html><body>"+"<script>var _ = function (msg) { parent.s._(msg, document); };<\/script>"+new Array(174).join(" "))}};HTMLFile.prototype.write=function(e){e="<script>_("+JSON.stringify(e)+");<\/script>";(this||me).response.write(e)&&((this||me).drained=true);(this||me).log.debug((this||me).name+" writing",e)};var ye=ve;var ke="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var we={};var Te=ge;we=we=HTTPPolling;function HTTPPolling(e,t,o){Te.call(this||ke,e,t,o)}HTTPPolling.prototype.__proto__=Te.prototype;HTTPPolling.prototype.name="httppolling";HTTPPolling.prototype.setHeartbeatInterval=function(){return this||ke};HTTPPolling.prototype.handleRequest=function(e){Te.prototype.handleRequest.call(this||ke,e);if("GET"==e.method){var t=this||ke;(this||ke).pollTimeout=setTimeout((function(){t.packet({type:"noop"});t.log.debug(t.name+" closed due to exceeded duration")}),1e3*(this||ke).manager.get("polling duration"));(this||ke).log.debug("setting poll timeout")}};HTTPPolling.prototype.clearPollTimeout=function(){if((this||ke).pollTimeout){clearTimeout((this||ke).pollTimeout);(this||ke).pollTimeout=null;(this||ke).log.debug("clearing poll timeout")}return this||ke};HTTPPolling.prototype.clearTimeouts=function(){Te.prototype.clearTimeouts.call(this||ke);this.clearPollTimeout()};HTTPPolling.prototype.doWrite=function(){this.clearPollTimeout()};HTTPPolling.prototype.write=function(e,t){this.doWrite(e);(this||ke).response.end();this.onClose()};HTTPPolling.prototype.end=function(){this.clearPollTimeout();return Te.prototype.end.call(this||ke)};var xe=we;var Se="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var Pe={};var Ce=u.Buffer;var Me=xe;Pe=Pe=XHRPolling;function XHRPolling(e,t,o){Me.call(this||Se,e,t,o)}XHRPolling.prototype.__proto__=Me.prototype;XHRPolling.prototype.name="xhr-polling";XHRPolling.prototype.doWrite=function(e){Me.prototype.doWrite.call(this||Se);var t=(this||Se).req.headers.origin,o={"Content-Type":"text/plain; charset=UTF-8","Content-Length":void 0===e?0:Ce.byteLength(e),Connection:"Keep-Alive"};if(t){o["Access-Control-Allow-Origin"]="*";(this||Se).req.headers.cookie&&(o["Access-Control-Allow-Credentials"]="true")}(this||Se).response.writeHead(200,o);(this||Se).response.write(e);(this||Se).log.debug((this||Se).name+" writing",e)};var Oe=Pe;var He="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var _e={};var qe=u.Buffer;var De=xe;_e=_e=JSONPPolling;function JSONPPolling(e,t,o){De.call(this||He,e,t,o);(this||He).head="io.j[0](";(this||He).foot=");";t.query.i&&((this||He).head="io.j["+t.query.i+"](")}JSONPPolling.prototype.__proto__=De.prototype;JSONPPolling.prototype.name="jsonppolling";JSONPPolling.prototype.postEncoded=true;JSONPPolling.prototype.onData=function(e){try{e=JSON.parse(e)}catch(e){this.error("parse","reconnect");return}De.prototype.onData.call(this||He,e)};JSONPPolling.prototype.doWrite=function(e){De.prototype.doWrite.call(this||He);var e=void 0===e?"":(this||He).head+JSON.stringify(e)+(this||He).foot;(this||He).response.writeHead(200,{"Content-Type":"text/javascript; charset=UTF-8","Content-Length":qe.byteLength(e),Connection:"Keep-Alive","X-XSS-Protection":"0"});(this||He).response.write(e);(this||He).log.debug((this||He).name+" writing",e)};var We=_e;var Fe={};Fe={websocket:ie,flashsocket:he,htmlfile:ye,"xhr-polling":Oe,"jsonp-polling":We};var $e=Fe;var Ae="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var Le={};var Ee=p,je=a;Le=Le=Memory;Memory.Client=Client;function Memory(e){je.call(this||Ae,e)}Memory.prototype.__proto__=je.prototype;Memory.prototype.publish=function(){};Memory.prototype.subscribe=function(){};Memory.prototype.unsubscribe=function(){};function Client(){je.Client.apply(this||Ae,arguments);(this||Ae).data={}}Client.prototype.__proto__=je.Client;Client.prototype.get=function(e,t){t(null,void 0===(this||Ae).data[e]?null:(this||Ae).data[e]);return this||Ae};Client.prototype.set=function(e,t,o){(this||Ae).data[e]=t;o&&o(null);return this||Ae};Client.prototype.has=function(e,t){t(null,e in(this||Ae).data)};Client.prototype.del=function(e,t){delete(this||Ae).data[e];t&&t(null);return this||Ae};Client.prototype.destroy=function(e){if("number"!=typeof e)(this||Ae).data={};else{var t=this||Ae;setTimeout((function(){t.data={}}),1e3*e)}return this||Ae};var Be=Le;var ze="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var Re={};var Ie=u.Buffer;var Ne=e,Ue=v,Je=r,Ge=n;var Ve={js:{type:"application/javascript",encoding:"utf8",gzip:true},swf:{type:"application/x-shockwave-flash",encoding:"binary",gzip:false}};var Xe=/\+((?:\+)?[\w\-]+)*(?:\.v\d+\.\d+\.\d+)?(?:\.js)$/,Ke=/\.v\d+\.\d+\.\d+(?:\.js)$/;Re=Re=Static;function Static(e){(this||ze).manager=e;(this||ze).cache={};(this||ze).paths={};this.init()}Static.prototype.init=function(){function id(e){var t=e.join("").split("").map((function(e){return(""+e.charCodeAt(0)).split("").pop()})).reduce((function(e,t){return e+t}));return Ne.version+":"+t}function build(t,o){Ne.builder(t,{minify:e.manager.enabled("browser client minification")},(function(e,r){o(e,r?new Ie(r):null,id(t))}))}var e=this||ze;this.add("/static/flashsocket/WebSocketMain.swf",{file:Ne.dist+"/WebSocketMain.swf"});this.add("/static/flashsocket/WebSocketMainInsecure.swf",{file:Ne.dist+"/WebSocketMainInsecure.swf"});this.add("/socket.io.js",(function(t,o){build(e.manager.get("transports"),o)}));this.add("/socket.io.v",{mime:Ve.js},(function(t,o){build(e.manager.get("transports"),o)}));this.add("/socket.io+",{mime:Ve.js},(function(t,o){var r=e.manager.get("transports"),i=t.match(Xe),n=[];if(!i)return o("No valid transports");i[0].split(".")[0].split("+").slice(1).forEach((function(e){!~r.indexOf(e)||n.push(e)}));if(!n.length)return o("No valid transports");build(n,o)}));(this||ze).manager.on("set:transports",(function(t,o){delete e.cache["/socket.io.js"];Object.keys(e.cache).forEach((function(t){Xe.test(t)&&delete e.cache[t]}))}))};Static.prototype.gzip=function(e,t){var o=Ue.spawn("gzip",["-9","-c","-f","-n"]),r=Ie.isBuffer(e)?"binary":"utf8",i=[],n;o.stdout.on("data",(function(e){i.push(e)}));o.stderr.on("data",(function(e){n=e+"";i.length=0}));o.on("exit",(function(){if(n)return t(n);var e=0,o=0,r=i.length,s;while(r--)e+=i[r].length;s=new Ie(e);r=i.length;i.forEach((function(e){var t=e.length;e.copy(s,o,0,t);o+=t}));i.length=0;t(null,s)}));o.stdin.end(e,r)};Static.prototype.has=function(e){if((this||ze).paths[e])return(this||ze).paths[e];var t=Object.keys((this||ze).paths),o=t.length;while(o--)if(-~e.indexOf(t[o]))return(this||ze).paths[t[o]];return false};Static.prototype.add=function(e,t,o){var r=/(?:\.(\w{1,4}))$/.exec(e);if(!o&&"function"==typeof t){o=t;t={}}t.mime=t.mime||!!r&&Ve[r[1]];o&&(t.callback=o);if(!(t.file||t.callback)||!t.mime)return false;(this||ze).paths[e]=t;return true};Static.prototype.write=function(e,t,o){function write(e,r,i,n){try{o.writeHead(e,r||void 0);o.end("HEAD"!==t.method&&i?i:"",n||void 0)}catch(e){}}function answer(o){var i=t.headers["if-none-match"]===o.etag;if(i&&r.manager.enabled("browser client etag"))return write(304);var n=t.headers["accept-encoding"]||"",s=!!~n.toLowerCase().indexOf("gzip"),a=o.mime,c=o.versioned,h={"Content-Type":a.type};r.manager.enabled("browser client etag")&&o.etag&&!c&&(h["Etag"]=o.etag);if(c){var l=r.manager.get("browser client expires");h["Cache-Control"]='private, x-gzip-ok="", max-age='+l;h["Date"]=(new Date).toUTCString();h["Expires"]=new Date(Date.now()+1e3*l).toUTCString()}if(s&&o.gzip){h["Content-Length"]=o.gzip.length;h["Content-Encoding"]="gzip";h["Vary"]="Accept-Encoding";write(200,h,o.gzip.content,a.encoding)}else{h["Content-Length"]=o.length;write(200,h,o.content,a.encoding)}r.manager.log.debug("served static content "+e)}var r=this||ze,i;if((this||ze).manager.enabled("browser client cache")&&(this||ze).cache[e])return answer((this||ze).cache[e]);if((this||ze).manager.get("browser client handler"))return(this||ze).manager.get("browser client handler").call(this||ze,t,o);if(i=this.has(e)){function ready(t,o,n){if(t){r.manager.log.warn("Unable to serve file. "+(t.message||t));return write(500,null,"Error serving static "+e)}var s=r.cache[e]={content:o,length:o.length,mime:i.mime,etag:n||Ne.version,versioned:Ke.test(e)};i.mime.gzip&&r.manager.enabled("browser client gzip")?r.gzip(o,(function(e,t){e||(s.gzip={content:t,length:t.length});answer(s)})):answer(s)}i.file?Je.readFile(i.file,ready):i.callback?i.callback.call(this||ze,e,ready):write(404,null,"File handle not found")}else write(404,null,"File not found")};var Qe=Re;var Ye="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var Ze={};var et=s;var tt=r,ot=i,rt=n,it=a,nt=e,st=$e,at=g,ct=l,ht=Be,lt=m,pt=Qe,ut=et.EventEmitter;Ze=Ze=Manager;var ft=Ze.defaultTransports=["websocket","htmlfile","xhr-polling","jsonp-polling"];var dt=(void 0).exports,gt=dt.protocol;function Manager(e,t){(this||Ye).server=e;(this||Ye).namespaces={};(this||Ye).sockets=this.of("");(this||Ye).settings={origins:"*:*",log:true,store:new ht,logger:new at,static:new pt(this||Ye),heartbeats:true,resource:"/socket.io",transports:ft,authorization:false,blacklist:["disconnect"],"log level":3,"log colors":true,"close timeout":25,"heartbeat timeout":15,"heartbeat interval":20,"polling duration":20,"flash policy server":true,"flash policy port":10843,"destroy upgrade":true,"browser client":true,"browser client cache":true,"browser client minification":false,"browser client etag":false,"browser client expires":31536e4,"browser client gzip":false,"browser client handler":false,"client store expiration":15};for(var o in t)(this||Ye).settings[o]=t[o];var r=this||Ye;this.initStore();this.on("set:store",(function(){r.initStore()}));(this||Ye).oldListeners=e.listeners("request");e.removeAllListeners("request");e.on("request",(function(e,t){r.handleRequest(e,t)}));e.on("upgrade",(function(e,t,o){r.handleUpgrade(e,t,o)}));e.on("close",(function(){clearInterval(r.gc)}));e.once("listening",(function(){r.gc=setInterval(r.garbageCollection.bind(r),1e4)}));for(var o in st)st[o].init&&st[o].init(this||Ye);(this||Ye).log.info("socket.io started")}Manager.prototype.__proto__=ut.prototype;Manager.prototype.__defineGetter__("store",(function(){var e=this.get("store");e.manager=this||Ye;return e}));Manager.prototype.__defineGetter__("log",(function(){var e=this.get("logger");e.level=this.get("log level")||-1;e.colors=this.get("log colors");e.enabled=this.enabled("log");return e}));Manager.prototype.__defineGetter__("static",(function(){return this.get("static")}));Manager.prototype.get=function(e){return(this||Ye).settings[e]};Manager.prototype.set=function(e,t){if(1==arguments.length)return this.get(e);(this||Ye).settings[e]=t;this.emit("set:"+e,(this||Ye).settings[e],e);return this||Ye};Manager.prototype.enable=function(e){(this||Ye).settings[e]=true;this.emit("set:"+e,(this||Ye).settings[e],e);return this||Ye};Manager.prototype.disable=function(e){(this||Ye).settings[e]=false;this.emit("set:"+e,(this||Ye).settings[e],e);return this||Ye};Manager.prototype.enabled=function(e){return!!(this||Ye).settings[e]};Manager.prototype.disabled=function(e){return!(this||Ye).settings[e]};Manager.prototype.configure=function(e,t){"function"==typeof e?e.call(this||Ye):"production"==e&&t.call(this||Ye);return this||Ye};Manager.prototype.initStore=function(){(this||Ye).handshaken={};(this||Ye).connected={};(this||Ye).open={};(this||Ye).closed={};(this||Ye).closedA=[];(this||Ye).rooms={};(this||Ye).roomClients={};var e=this||Ye;(this||Ye).store.subscribe("handshake",(function(t,o){e.onHandshake(t,o)}));(this||Ye).store.subscribe("connect",(function(t){e.onConnect(t)}));(this||Ye).store.subscribe("open",(function(t){e.onOpen(t)}));(this||Ye).store.subscribe("join",(function(t,o){e.onJoin(t,o)}));(this||Ye).store.subscribe("leave",(function(t,o){e.onLeave(t,o)}));(this||Ye).store.subscribe("close",(function(t){e.onClose(t)}));(this||Ye).store.subscribe("dispatch",(function(t,o,r,i){e.onDispatch(t,o,r,i)}));(this||Ye).store.subscribe("disconnect",(function(t){e.onDisconnect(t)}))};Manager.prototype.onHandshake=function(e,t){(this||Ye).handshaken[e]=t};Manager.prototype.onConnect=function(e){(this||Ye).connected[e]=true};Manager.prototype.onOpen=function(e){(this||Ye).open[e]=true;if((this||Ye).closed[e]){var t=this||Ye;(this||Ye).closedA.splice((this||Ye).closedA.indexOf(e),1);(this||Ye).store.unsubscribe("dispatch:"+e,(function(){delete t.closed[e]}))}if((this||Ye).transports[e]){(this||Ye).transports[e].discard();(this||Ye).transports[e]=null}};Manager.prototype.onDispatch=function(e,t,o,r){if((this||Ye).rooms[e])for(var i=0,n=(this||Ye).rooms[e].length;i<n;i++){var s=(this||Ye).rooms[e][i];~r.indexOf(s)||((this||Ye).transports[s]&&(this||Ye).transports[s].open?(this||Ye).transports[s].onDispatch(t,o):o||this.onClientDispatch(s,t))}};Manager.prototype.onJoin=function(e,t){(this||Ye).roomClients[e]||((this||Ye).roomClients[e]={});(this||Ye).rooms[t]||((this||Ye).rooms[t]=[]);if(!~(this||Ye).rooms[t].indexOf(e)){(this||Ye).rooms[t].push(e);(this||Ye).roomClients[e][t]=true}};Manager.prototype.onLeave=function(e,t){if((this||Ye).rooms[t]){var o=(this||Ye).rooms[t].indexOf(e);o>=0&&(this||Ye).rooms[t].splice(o,1);(this||Ye).rooms[t].length||delete(this||Ye).rooms[t];delete(this||Ye).roomClients[e][t]}};Manager.prototype.onClose=function(e){(this||Ye).open[e]&&delete(this||Ye).open[e];(this||Ye).closed[e]=[];(this||Ye).closedA.push(e);var t=this||Ye;(this||Ye).store.subscribe("dispatch:"+e,(function(o,r){r||t.onClientDispatch(e,o)}))};Manager.prototype.onClientDispatch=function(e,t){(this||Ye).closed[e]&&(this||Ye).closed[e].push(t)};Manager.prototype.onClientMessage=function(e,t){(this||Ye).namespaces[t.endpoint]&&(this||Ye).namespaces[t.endpoint].handlePacket(e,t)};Manager.prototype.onClientDisconnect=function(e,t){for(var o in(this||Ye).namespaces)(this||Ye).roomClients[e][o]&&(this||Ye).namespaces[o].handleDisconnect(e,t);this.onDisconnect(e)};Manager.prototype.onDisconnect=function(e,t){delete(this||Ye).handshaken[e];(this||Ye).open[e]&&delete(this||Ye).open[e];(this||Ye).connected[e]&&delete(this||Ye).connected[e];if((this||Ye).transports[e]){(this||Ye).transports[e].discard();delete(this||Ye).transports[e]}if((this||Ye).closed[e]){delete(this||Ye).closed[e];(this||Ye).closedA.splice((this||Ye).closedA.indexOf(e),1)}if((this||Ye).roomClients[e]){for(var o in(this||Ye).roomClients[e])this.onLeave(e,o);delete(this||Ye).roomClients[e]}(this||Ye).store.destroyClient(e,this.get("client store expiration"));(this||Ye).store.unsubscribe("dispatch:"+e);if(t){(this||Ye).store.unsubscribe("message:"+e);(this||Ye).store.unsubscribe("disconnect:"+e)}};Manager.prototype.handleRequest=function(e,t){var o=this.checkRequest(e);if(o)if(o.static||!o.transport&&!o.protocol)if(o.static&&this.enabled("browser client"))(this||Ye).static.write(o.path,e,t);else{t.writeHead(200);t.end("Welcome to socket.io.");(this||Ye).log.info("unhandled socket.io url")}else if(o.protocol!=gt){t.writeHead(500);t.end("Protocol version not supported.");(this||Ye).log.info("client protocol version unsupported")}else o.id?this.handleHTTPRequest(o,e,t):this.handleHandshake(o,e,t);else for(var r=0,i=(this||Ye).oldListeners.length;r<i;r++)(this||Ye).oldListeners[r].call((this||Ye).server,e,t)};Manager.prototype.handleUpgrade=function(e,t,o){var r=this.checkRequest(e),i=this||Ye;if(r){e.head=o;this.handleClient(r,e)}else if(this.enabled("destroy upgrade")){t.end();(this||Ye).log.debug("destroying non-socket.io upgrade")}};Manager.prototype.handleHTTPRequest=function(e,t,o){t.res=o;this.handleClient(e,t)};Manager.prototype.handleClient=function(e,t){var o=t.socket,r=(this||Ye).store,i=this||Ye;if(void 0==e.query.disconnect)if(~this.get("transports").indexOf(e.transport)){var n=new st[e.transport](this||Ye,e,t),s=(this||Ye).handshaken[e.id];if(s){if(n.open){if((this||Ye).closed[e.id]&&(this||Ye).closed[e.id].length){n.payload((this||Ye).closed[e.id]);(this||Ye).closed[e.id]=[]}this.onOpen(e.id);(this||Ye).store.publish("open",e.id);(this||Ye).transports[e.id]=n}if(!(this||Ye).connected[e.id]){this.onConnect(e.id);(this||Ye).store.publish("connect",e.id);delete s.issued;this.onHandshake(e.id,s);(this||Ye).store.publish("handshake",e.id,s);for(var a in(this||Ye).namespaces){var o=(this||Ye).namespaces[a].socket(e.id,true);""===a&&(this||Ye).namespaces[a].handlePacket(e.id,{type:"connect"})}(this||Ye).store.subscribe("message:"+e.id,(function(t){i.onClientMessage(e.id,t)}));(this||Ye).store.subscribe("disconnect:"+e.id,(function(t){i.onClientDisconnect(e.id,t)}))}}else{n.open&&n.error("client not handshaken","reconnect");n.discard()}}else{(this||Ye).log.warn('unknown transport: "'+e.transport+'"');t.connection.end()}else(this||Ye).transports[e.id]&&(this||Ye).transports[e.id].open?(this||Ye).transports[e.id].onForcedDisconnect():(this||Ye).store.publish("disconnect-force:"+e.id)};Manager.prototype.generateId=function(){return Math.abs(Math.random()*Math.random()*Date.now()|0).toString()+Math.abs(Math.random()*Math.random()*Date.now()|0).toString()};Manager.prototype.handleHandshake=function(e,t,o){var r=this||Ye,i=t.headers.origin,n={"Content-Type":"text/plain"};function writeErr(t,r){if(e.query.jsonp){o.writeHead(200,{"Content-Type":"application/javascript"});o.end("io.j["+e.query.jsonp+'](new Error("'+r+'"));')}else{o.writeHead(t,n);o.end(r)}}function error(e){writeErr(500,"handshake error");r.log.warn("handshake error "+e)}if(this.verifyOrigin(t)){var s=this.handshakeData(e);if(i){n["Access-Control-Allow-Origin"]="*";t.headers.cookie&&(n["Access-Control-Allow-Credentials"]="true")}this.authorize(s,(function(t,i,a){if(t)return error(t);if(i){var c=r.generateId(),h=[c,r.enabled("heartbeats")&&r.get("heartbeat timeout")||"",r.get("close timeout")||"",r.transports(e).join(",")].join(":");if(e.query.jsonp){h="io.j["+e.query.jsonp+"]("+JSON.stringify(h)+");";o.writeHead(200,{"Content-Type":"application/javascript"})}else o.writeHead(200,n);o.end(h);r.onHandshake(c,a||s);r.store.publish("handshake",c,a||s);r.log.info("handshake authorized",c)}else{writeErr(403,"handshake unauthorized");r.log.info("handshake unauthorized")}}))}else writeErr(403,"handshake bad origin")};Manager.prototype.handshakeData=function(e){var t=e.request.connection,o,r=new Date;t.remoteAddress?o={address:t.remoteAddress,port:t.remotePort}:t.socket&&t.socket.remoteAddress&&(o={address:t.socket.remoteAddress,port:t.socket.remotePort});return{headers:e.headers,address:o,time:r.toString(),query:e.query,url:e.request.url,xdomain:!!e.request.headers.origin,secure:e.request.connection.secure,issued:+r}};Manager.prototype.verifyOrigin=function(e){var t=e.headers.origin||e.headers.referer,o=this.get("origins");"null"===t&&(t="*");if(-1!==o.indexOf("*:*"))return true;if(t)try{var r=ot.parse(t);var i=~o.indexOf(r.hostname+":"+r.port)||~o.indexOf(r.hostname+":*")||~o.indexOf("*:"+r.port);i||(this||Ye).log.warn("illegal origin: "+t);return i}catch(e){(this||Ye).log.warn("error parsing origin")}else(this||Ye).log.warn("origin missing from handshake, yet required by config");return false};Manager.prototype.handlePacket=function(e,t){this.of(t.endpoint||"").handlePacket(e,t)};Manager.prototype.authorize=function(e,t){if(this.get("authorization")){var o=this||Ye;this.get("authorization").call(this||Ye,e,(function(e,r){o.log.debug("client "+r?"authorized":"unauthorized");t(e,r)}))}else{(this||Ye).log.debug("client authorized");t(null,true)}return this||Ye};Manager.prototype.transports=function(e){var t=this.get("transports"),o=[];for(var r=0,i=t.length;r<i;r++){var n=t[r];n&&(n.checkClient&&!n.checkClient(e)||o.push(n))}return o};var mt=/^\/([^\/]+)\/?([^\/]+)?\/?([^\/]+)?\/?$/;Manager.prototype.checkRequest=function(e){var t=this.get("resource");if(e.url.substr(0,t.length)==t){var o=ot.parse(e.url.substr(t.length),true),r=o.pathname||"",i=r.match(mt);var n={query:o.query||{},headers:e.headers,request:e,path:r};if(i){n.protocol=Number(i[1]);n.transport=i[2];n.id=i[3];n.static=!!(this||Ye).static.has(r)}return n}return false};Manager.prototype.of=function(e){return(this||Ye).namespaces[e]?(this||Ye).namespaces[e]:(this||Ye).namespaces[e]=new lt(this||Ye,e)};Manager.prototype.garbageCollection=function(){var e=Object.keys((this||Ye).handshaken),t=e.length,o=Date.now(),r;while(t--){r=(this||Ye).handshaken[e[t]];"issued"in r&&o-r.issued>=3e4&&this.onDisconnect(e[t])}};var vt=Ze;var bt={};var yt=e;bt.version="0.8.6";bt.protocol=1;bt.clientVersion=yt.version;bt.listen=function(e,r,i){if("function"==typeof r){i=r;r={}}"undefined"==typeof e&&(e=80);if("number"==typeof e){var n=e;e=r&&r.key?t.createServer(r):o.createServer();e.on("request",(function(e,t){t.writeHead(200);t.end("Welcome to socket.io.")}));e.listen(n,i)}return new bt.Manager(e,r)};bt.Manager=vt;bt.Transport=w;bt.Socket=l;bt.Static=Qe;bt.Store=a;bt.MemoryStore=Be;bt.RedisStore=c;bt.parser=h;const kt=bt.version,wt=bt.protocol,Tt=bt.clientVersion,xt=bt.listen,St=bt.Manager,Pt=bt.Transport,Ct=bt.Socket,Mt=bt.Static,Ot=bt.Store,Ht=bt.MemoryStore,_t=bt.RedisStore,qt=bt.parser;export default bt;export{St as Manager,Ht as MemoryStore,_t as RedisStore,Ct as Socket,Mt as Static,Ot as Store,Pt as Transport,Tt as clientVersion,xt as listen,qt as parser,wt as protocol,kt as version};

